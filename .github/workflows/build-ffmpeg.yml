name: Build FFmpeg with libx264

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      FFMPEG_BUILD_DIR: /home/runner/ffmpeg_build
      FFMPEG_LIBS_DIR: /home/runner/ffmpeg_build/ffmpeg_libs
      FFMPEG_BIN_INSTALLED_DIR: /home/runner/ffmpeg_build/bin_installed
      # ADD THIS LINE:
      PKG_CONFIG_PATH: /home/runner/ffmpeg_build/ffmpeg_libs/lib/pkgconfig # Point to where x264.pc is installed

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # No need for the 'Set up build directory' step's `echo` commands for env vars
    # as they are now defined globally at the job level.
    # You might still want the mkdir -p command here though if not doing it elsewhere.
    - name: Ensure build directories exist
      run: |
        mkdir -p "${{ env.FFMPEG_BUILD_DIR }}"
        # No need to set env vars here anymore as they are global
        # echo "FFMPEG_BUILD_DIR=$HOME/ffmpeg_build" >> $GITHUB_ENV
        # echo "FFMPEG_LIBS_DIR=$HOME/ffmpeg_build/ffmpeg_libs" >> $GITHUB_ENV
        # echo "FFMPEG_BIN_INSTALLED_DIR=$HOME/ffmpeg_build/bin_installed" >> $GITHUB_ENV
        # Also, the PATH should ideally be set in the 'env' block if you want it for all steps
        # If you need it only for certain commands, you can still add it like this.
        # But for 'ffmpeg' command later, it's better to be in the job's env block or shell profile
        echo "Adding $HOME/bin to PATH for this runner session"
        echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV # Ensure $HOME/bin is in PATH for subsequent steps

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential autoconf automake cmake libtool pkg-config nasm yasm git

    - name: Build libx264
      working-directory: ${{ env.FFMPEG_BUILD_DIR }}
      run: |
        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        ./configure --prefix="${{ env.FFMPEG_LIBS_DIR }}" --enable-static --disable-opencl
        make -j$(nproc)
        make install

    - name: Build FFmpeg
      working-directory: ${{ env.FFMPEG_BUILD_DIR }}
      run: |
        git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg
        cd ffmpeg
        # The configure command remains the same, but now PKG_CONFIG_PATH is correctly set globally
        ./configure \
          --prefix="${{ env.FFMPEG_BIN_INSTALLED_DIR }}" \
          --pkg-config-flags="--static" \
          --extra-cflags="-I${{ env.FFMPEG_LIBS_DIR }}/include" \
          --extra-ldflags="-L${{ env.FFMPEG_LIBS_DIR }}/lib" \
          --bindir="$HOME/bin" \
          --enable-gpl \
          --enable-libx264 \
          --enable-nonfree \
          --disable-shared \
          --enable-static \
          --disable-doc \
          --disable-debug \
          --disable-ffplay \
          --disable-ffprobe
        make -j$(nproc)
        make install

    - name: Verify FFmpeg installation
      run: |
        ffmpeg -version
        which ffmpeg

    - name: Package FFmpeg binaries
      run: |
        cd "$HOME/bin"
        tar -czvf ffmpeg-binaries-linux-amd64.tar.gz ffmpeg ffprobe

    - name: Upload FFmpeg binaries as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-linux-amd64
        path: ${{ env.HOME }}/bin/ffmpeg-binaries-linux-amd64.tar.gz
        retention-days: 7
